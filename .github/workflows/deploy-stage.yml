name: Build and Deploy ECOF Website

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Build le site
  build:
    runs-on: ubuntu-latest
    name: Build Website
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build Astro site
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: website-build
        path: dist/
        retention-days: 7

  # Job 2: Deploy vers AWS S3 (seulement sur main)
  deploy:
    runs-on: ubuntu-latest
    needs: build
    name: Deploy to AWS
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: website-build
        path: dist/

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-3

    - name: Deploy to S3
      run: |
        # Nom du bucket S3 (à adapter selon ton bucket)
        S3_BUCKET="ecof-website-stage-6e85ed80"
        
        # Sync des fichiers vers S3
        aws s3 sync dist/ s3://$S3_BUCKET \
          --delete \
          --cache-control "public, max-age=31536000" \
          --exclude "*.html"
        
        # HTML avec cache plus court
        aws s3 sync dist/ s3://$S3_BUCKET \
          --cache-control "public, max-age=3600" \
          --include "*.html"

    - name: Invalidate CloudFront (optional)
      run: |
        # ID de distribution CloudFront (à adapter)
        DISTRIBUTION_ID="d1zcuce5tj6u3s"
        
        # Invalider le cache CloudFront
        aws cloudfront create-invalidation \
          --distribution-id $DISTRIBUTION_ID \
          --paths "/*"
      continue-on-error: true

  # Job 3: Tests de base (optionnel)
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check TypeScript
      run: npx tsc --noEmit
      continue-on-error: true

    - name: Lint check (if available)
      run: npm run lint --if-present
      continue-on-error: true