name: Build and Deploy ECOF Website

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Permissions n√©cessaires pour OIDC
permissions:
  id-token: write
  contents: read

jobs:
  # Job 1: Build le site
  build:
    runs-on: ubuntu-latest
    name: Build Website
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build Astro site
      run: npm run build
      env:
        CMS_GITHUB_TOKEN: ${{ secrets.CMS_GITHUB_TOKEN }}
        CMS_PASSWORD: ${{ secrets.CMS_PASSWORD }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: website-build
        path: dist/
        retention-days: 7

  # Job 2: Deploy vers AWS S3 (seulement sur main)
  deploy:
    runs-on: ubuntu-latest
    needs: build
    name: Deploy to AWS
    if: github.ref == 'refs/heads/main'
    environment: stage
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: website-build
        path: dist/

    - name: Configure AWS credentials with OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        role-session-name: GitHubActions-ECOF-Deploy
        aws-region: eu-west-3

    - name: Get AWS caller identity (for verification)
      run: aws sts get-caller-identity

    - name: Deploy site to S3
      run: |
        # Nom du bucket S3 
        S3_BUCKET="ecof-website-stage-6e85ed80"
        
        echo "üöÄ D√©ploiement du site complet vers S3"
        # D√©ployer tous les assets avec cache long (sauf HTML et fichiers admin)
        aws s3 sync dist/ s3://$S3_BUCKET \
          --delete \
          --cache-control "public, max-age=31536000" \
          --exclude "*.html" \
          --exclude "admin/*"
        
        # D√©ployer les fichiers HTML avec cache court
        aws s3 sync dist/ s3://$S3_BUCKET \
          --cache-control "public, max-age=3600" \
          --include "*.html"
        
    - name: Invalidate CloudFront
      run: |
        # ID de distribution CloudFront (corrig√©)
        DISTRIBUTION_ID="EA2FNVF5R7H6G"
        
        echo "üîÑ Invalidation CloudFront: $DISTRIBUTION_ID"
        
        # V√©rifier que la distribution existe
        if aws cloudfront get-distribution --id $DISTRIBUTION_ID > /dev/null 2>&1; then
          # Invalider le cache CloudFront
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "‚úÖ Invalidation cr√©√©e: $INVALIDATION_ID"
          echo "üåê Site disponible sur: https://d1zcuce5tj6u3s.cloudfront.net"
        else
          echo "‚ö†Ô∏è  Distribution CloudFront $DISTRIBUTION_ID non trouv√©e ou pas d'acc√®s"
          echo "üåê V√©rifiez l'ID de distribution dans le workflow"
        fi

  # Job 3: Tests de base (optionnel)
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check TypeScript
      run: npx tsc --noEmit
      continue-on-error: true

    - name: Lint check (if available)
      run: npm run lint --if-present
      continue-on-error: true